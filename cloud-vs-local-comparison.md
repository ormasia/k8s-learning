# äº‘ç¯å¢ƒ vs æœ¬åœ°ç¯å¢ƒçš„ Controller Manager å¯¹æ¯”

## ğŸ  æœ¬åœ°ç¯å¢ƒï¼ˆKind é›†ç¾¤ï¼‰- å½“å‰æƒ…å†µ

### æ¶æ„ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    kube-controller-manager          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚     æ‰€æœ‰æ§åˆ¶å™¨éƒ½åœ¨è¿™é‡Œ        â”‚  â”‚
â”‚  â”‚  âœ… ReplicaSet Controller     â”‚  â”‚
â”‚  â”‚  âœ… Deployment Controller     â”‚  â”‚
â”‚  â”‚  âœ… Service Controller        â”‚  â”‚
â”‚  â”‚  âœ… Node Controller           â”‚  â”‚
â”‚  â”‚  âœ… PV/PVC Controller         â”‚  â”‚
â”‚  â”‚  âœ… Namespace Controller      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âŒ æ²¡æœ‰ cloud-controller-manager
âŒ æ²¡æœ‰äº‘è´Ÿè½½å‡è¡¡å™¨
âŒ æ²¡æœ‰äº‘å­˜å‚¨åŠ¨æ€é¢„é…
âŒ æ²¡æœ‰äº‘è·¯ç”±ç®¡ç†
```

### å¯åŠ¨å‚æ•°ï¼š
```bash
kube-controller-manager:
  --controllers=*,bootstrapsigner,tokencleaner
  --enable-hostpath-provisioner=true
  # æ³¨æ„ï¼šæ²¡æœ‰ --cloud-provider å‚æ•°
```

## â˜ï¸ çœŸå®äº‘ç¯å¢ƒï¼ˆAWS EKS ç¤ºä¾‹ï¼‰

### æ¶æ„ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    kube-controller-manager      â”‚  â”‚   aws-cloud-controller-manager  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚     æ ¸å¿ƒæ§åˆ¶å™¨           â”‚  â”‚  â”‚  â”‚    AWS ç‰¹å®šæ§åˆ¶å™¨         â”‚  â”‚
â”‚  â”‚  âœ… ReplicaSet           â”‚  â”‚  â”‚  â”‚  âœ… AWS Node Controller    â”‚  â”‚
â”‚  â”‚  âœ… Deployment           â”‚  â”‚  â”‚  â”‚  âœ… AWS Route Controller   â”‚  â”‚
â”‚  â”‚  âœ… Job/CronJob          â”‚  â”‚  â”‚  â”‚  âœ… AWS Service Controller â”‚  â”‚
â”‚  â”‚  âœ… Namespace            â”‚  â”‚  â”‚  â”‚     (ELB/ALB ç®¡ç†)        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¯åŠ¨å‚æ•°ï¼š
```bash
# kube-controller-manager
kube-controller-manager:
  --controllers=*,bootstrapsigner,tokencleaner
  --cloud-provider=external  # ğŸ”‘ å…³é”®å·®å¼‚
  
# aws-cloud-controller-manager (å•ç‹¬ Pod)
aws-cloud-controller-manager:
  --cloud-provider=aws
  --configure-cloud-routes=true
  --cluster-name=my-eks-cluster
```

## ğŸ”„ å®é™…åŠŸèƒ½å¯¹æ¯”

### Service ç±»å‹æ”¯æŒï¼š

#### Kind é›†ç¾¤ï¼ˆå½“å‰ï¼‰ï¼š
```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-service
spec:
  type: LoadBalancer  # âš ï¸ ä¼šä¸€ç›´ Pending
  ports:
  - port: 80
  selector:
    app: my-app

# ç»“æœï¼šEXTERNAL-IP ä¼šæ˜¾ç¤º <pending>
# å› ä¸ºæ²¡æœ‰äº‘æ§åˆ¶å™¨æ¥åˆ›å»ºçœŸå®çš„è´Ÿè½½å‡è¡¡å™¨
```

#### AWS EKS é›†ç¾¤ï¼š
```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-service
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
spec:
  type: LoadBalancer
  ports:
  - port: 80
  selector:
    app: my-app

# ç»“æœï¼šAWS CCM ä¼šè‡ªåŠ¨åˆ›å»º Network Load Balancer
# EXTERNAL-IP ä¼šæ˜¾ç¤ºçœŸå®çš„ AWS NLB åœ°å€
```
å·®ä¸€ç‚¹ç‚¹ï¼Œä½ ç†è§£é‡Œæœ‰ç‚¹â€œæ··çº¿â€äº†ï¼Œæˆ‘å¸®ä½ ç†ä¸€ä¸‹ï¼š

---

## ğŸ§© CCM å’Œäº‘èµ„æºçš„å…³ç³»

* **Node â‰  äº‘èµ„æºçš„å…¨éƒ¨**

  * Node åªæ˜¯äº‘èµ„æºä¸­çš„ä¸€ç±»ï¼ˆäº‘ä¸Šçš„è™šæ‹Ÿæœºå®ä¾‹ / ç‰©ç†æœºï¼‰ï¼Œå®ƒä¼šè¢«åŠ å…¥åˆ°é›†ç¾¤ï¼Œæˆä¸ºè°ƒåº¦çš„å·¥ä½œèŠ‚ç‚¹ã€‚
  * ä½†äº‘ä¸Šèµ„æºè¿˜åŒ…æ‹¬ï¼šè´Ÿè½½å‡è¡¡ï¼ˆLBï¼‰ã€å­˜å‚¨å·ï¼ˆEBSã€OSSã€PDï¼‰ã€è·¯ç”±è¡¨ç­‰ã€‚

* **CCM çš„ä½œç”¨**

  * **ä¸æ˜¯æŠŠäº‘èµ„æºéƒ½å½“ Node**ï¼Œè€Œæ˜¯æŠŠä¸åŒç±»å‹çš„äº‘èµ„æºå¯¹æ¥è¿› Kubernetesï¼š

    1. **Node Controller** â†’ äº‘ä¸Šçš„ VM å’Œ K8s Node å¯¹é½ï¼ˆå¦‚æœ VM è¢«åˆ ï¼ŒK8s Node ä¹Ÿä¼šç§»é™¤ï¼‰ã€‚
    2. **Service Controller** â†’ K8s `Service(type=LoadBalancer)` å¯¹åº”åˆ›å»ºäº‘ LBã€‚
    3. **Route Controller** â†’ é…ç½®äº‘è·¯ç”±ï¼Œè®© Pod è·¨èŠ‚ç‚¹äº’é€šã€‚
    4. **Volume Controller** â†’ åˆ›å»ºã€æŒ‚è½½äº‘å­˜å‚¨å·ï¼Œæ”¯æ’‘ PVã€‚

---

## ğŸ“Œ ç±»æ¯”ç†è§£

ä½ å¯ä»¥æŠŠ CCM ç†è§£æˆä¸€ä¸ªâ€œç¿»è¯‘å®˜â€ï¼š

* Kubernetes è¯´ï¼šæˆ‘è¦ä¸€ä¸ª LB â†’ CCM è°ƒç”¨äº‘ API åˆ›å»ºä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨ã€‚
* Kubernetes è¯´ï¼šæˆ‘è¦ä¸€ä¸ª PV â†’ CCM è°ƒç”¨äº‘ API ç”³è¯·ä¸€å—äº‘ç›˜å¹¶æŒ‚è½½ã€‚
* Kubernetes è¯´ï¼šè¿™ä¸ª Node ä¸å­˜åœ¨äº† â†’ CCM æ£€æŸ¥äº‘ APIï¼Œå‘ç° VM è¢«åˆ ï¼Œå°±æŠŠ Node åˆ é™¤ã€‚

---

## âœ… ç»“è®º

* äº‘èµ„æº â‰  Nodeã€‚
* Node æ˜¯äº‘èµ„æºçš„ä¸€éƒ¨åˆ†ï¼ˆäº‘ VM å®ä¾‹ï¼‰ï¼Œä½† CCM ç®¡çš„ä¸æ­¢ Nodeï¼Œè¿˜åŒ…æ‹¬ **LB / è·¯ç”± / å­˜å‚¨å·**ã€‚
* **CCM å°±æ˜¯ Kubernetes å’Œäº‘å‚å•† API çš„â€œæ¡¥æ¢â€ï¼Œè´Ÿè´£æŠŠ K8s é‡Œçš„æŠ½è±¡ï¼ˆNodeã€Serviceã€PVã€Routeï¼‰æ˜ å°„åˆ°å…·ä½“çš„äº‘èµ„æºã€‚**

---

è¦ä¸è¦æˆ‘å¸®ä½ ç”»ä¸€ä¸ª **â€œCCM ä¸äº‘èµ„æºæ˜ å°„å…³ç³»å›¾â€**ï¼Œç›´è§‚å±•ç¤º Nodeã€Serviceã€PV åˆ†åˆ«è½åˆ°äº‘ä¸Šå“ªäº›èµ„æºï¼Ÿ
